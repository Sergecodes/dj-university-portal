{% extends "core/base.html" %}

{% load static %}
{% load i18n %}

{% block title %}
	<title>{% trans 'Photo upload demo' %}</title>
{% endblock %}

{% block extra_css %}
	<link rel="stylesheet" href="{% static 'css/marketplace.css' %}">
{% endblock extra_css %}

{% block header %}
{% endblock %}

{% block institution_searchbox %}
{% endblock %}

{% block content %}
	<div class="mt-2 mb-4 gallery-container">
		{# button to trigger click event on input type=file button (.js-file-upload button) #}
		<button type="button" class="d-block btn btn-secondary js-upload-photos">
			<i class="fas fa-cloud-upload-alt" aria-hidden="true"></i> 
			{% trans 'Upload photos' %}
		</button>
		<span class="form-text text-muted">{% trans 'Upload at least 3 photos.' %}</span>

		{# input type="file" to be used by the file upload plugin, dispay set to none. #}
		{# note that the name attribute should be the same name used in the backend form #}
		<input 
			class="js-file-upload" 
			type="file" 
			name="file"
			style="display: none;" 
			data-url="{% url 'marketplace:photo-upload' %}"
			data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'
			multiple 
		>
		<hr class="my-2">
		<!-- container for photos -->
		<div class="row m-auto js-gallery"></div>
		<hr class="my-2">

		<!-- container for any errors(notably if user doesn't upload the minimum number of photos) -->
		<div class="js-photo-errors"></div>
	</div>

	<!-- progress bar modal. PS modals are hidden by default -->
	<div class="modal fade js-modal-progress" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
				<h4 class="modal-title">{% trans 'Uploading' %}...</h4>
				</div>
				<div class="modal-body">
				<div class="progress">
					<div 
						class="progress-bar js-progress-bar" 
						role="progressbar" 
						style="width: 0%;"
					>
						0%
					</div>
				</div>
				</div>
			</div>
		</div>
	</div>
{% endblock content %}

{% block footer %}
{% endblock %}

{% block extra_js %}
	{# jquery file upload scripts #}
	<script src="{% static 'js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
	<script src="{% static 'js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
	<script src="{% static 'js/jquery-file-upload/jquery.fileupload.js' %}"></script>

	<script>
		/* 1. OPEN THE FILE EXPLORER WINDOW */
		$(".js-upload-photos").click(function () {
			$('.js-file-upload').click();
		});

		/* 2. INITIALIZE THE FILE UPLOAD COMPONENT */
		var $modalProgress = $('.js-modal-progress'), $progressBar = $('.js-progress-bar');
		var $gallery = $('.js-gallery');

		// don't cache $('.js-file-upload'). if u do so, this plugin won't work (photos won't be uploaded)
		$('.js-file-upload').fileupload({
			dataType: 'json',
			sequentialUploads: false,  /* send and get the files one by one */
			start: function (e) {  
				// show modal when uploading process starts
				console.log("started upload");
				$modalProgress.first().modal("show");
			},
			stop: function (e) {  
				// when uploading has terminated, hide the modal */
				$modalProgress.first().modal("hide");
			},
			progressall: function (e, data) { 
				// update the progress bar
				var progress = parseInt(data.loaded / data.total * 100, 10);
				var strProgress = progress + "%";
				$progressBar.css({"width": strProgress}).text(strProgress);
			},
			done: function (e, data) {
				// data received from backend is stored in "data.result"
				var result = data.result;
				
				if (result.is_valid) {
					// "<tr><td><a href='" + data.result.url + "'>" + data.result.name + "</a></td></tr>"
					$gallery.append(
						"<div class='col-4 col-lg-3 my-2 photo-wrp js-photo-wrp'> \
							<img \
								src='" + result.url + "' \
								class='photo-wrp__img' \
								alt='" + result.title + "' \
								data-id='" + result.id + "' \
							> \
							<button  \
								type='button' \
								class='btn-close js-remove-photo' \
								aria-label='" + "{% trans 'Delete' %}" + "' \
							></button> \
						</div>"
					);
				} else {
					alert('invalid');
				}
			}
		});

		$('.js-gallery').on('click', '.js-remove-photo', function() {
			var $this = $(this);
			$this.closest('.js-photo-wrp').remove();
		});

		/*
		$('.js-gallery').on('click', '.js-remove-photo', function() {
			var $this = $(this);
			
			// get photo corresponding to clicked close button
			var $photo = $this.closest('.js-photo-wrp').children('img:first-child');
			// [0] is used to get the dom element from the jQuery object
			var photoId = parseInt($photo[0].dataset['id'], 0);
			
			var errorMessage = {% blocktrans %} "An error occurred, perhaps you aren't connected to the internet" {% endblocktrans %};

			// call ajax to delete photo from backend
			$.ajax({
				url: "{% url 'marketplace:photo-delete' %}" + '?photo_id=' + photoId,
				type: 'DELETE',
				dataType: 'json',
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
				},
				success: function(result) {
					if (result.deleted) {
						// remove photo from frontend
						// remember $this refers to the close button..
						$this.closest('.js-photo-wrp').remove();
					}
				},
				error: function() {
					alert(errorMessage);
				}
			});
		});
		*/
	</script>
{% endblock %}