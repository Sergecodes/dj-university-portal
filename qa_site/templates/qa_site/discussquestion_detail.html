{% extends "core/base.html" %}

{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load flag_tags %}
{% load app_extras %}  

{% get_current_language as LANGUAGE_CODE %}

{% block title %}
	<title>{{ question|safe }} | CamerSchools</title>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/jquery-comments.css' %}">
{% endblock %}

{% block extra_script_pre %}
	{% comment %} <script type="text/javascript" src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
	<script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
	<script type="text/javascript" src="{% static 'ckeditor/ckeditor/adapters/jquery.js' %}"></script> {% endcomment %}

	<script src="{% static 'js/jquery.textcomplete.js' %}"></script>
	{% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.textcomplete/1.8.0/jquery.textcomplete.js"></script> {% endcomment %}
	<script src="{% static 'js/jquery-comments.js' %}"></script>
{% endblock %}

{% block institution_searchbox %}
{% endblock %}


{% block content %}
<!-- toasts -->
<div class="toast hide alert alert-purple align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-custom-success-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body js-toast-message">
			{# message will be inserted here via js #}
		</div>
		<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
	</div>
</div>
<div class="toast hide alert alert-danger align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-custom-error-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body js-toast-message">
			{# custom message will be inserted here via js #}
		</div>
		<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
	</div>
</div>
<div class="toast hide alert alert-danger align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-login-required-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body">
			{% trans 'You need to be logged in to perform this operation.' %} 
			<p class="text-dark mt-1 mb-0">
				{% trans 'Click' %} 
				<a href="{% url 'users:login' %}?next={{ request.get_full_path }}">
					{% trans 'here' %}
				</a> 
				{% trans 'to login to your account or' %} 
				<a href="{% url 'users:register' %}" target="_blank">
					{% trans 'here' %}
				</a> 
				{% trans "to sign up if you don't yet have an account." %}
			</p>
		</div>
		<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
	</div>
</div>
<div class="toast hide alert alert-danger align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-self-vote-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body">
			{% trans "You can't vote for your own post" %} 
		</div>
		<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
	</div>
</div>
<div class="toast hide alert alert-danger align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-error-occurred-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body">
			<p>
				{% trans 'An error occured, refresh the page then try again.' %} <br>
				{% trans 'If it persists, contact us.' %}
			</p>
		</div>
		<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
	</div>
</div>
<div class="toast hide alert alert-purple align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-followed-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body">
			<p>	
				{% blocktrans %}
					You are now following this question. You'll receive notifications when there's activity on this post.
				{% endblocktrans %} <br>
				{% trans 'Click' %}
				<a href="{% url 'users:profile-qa' %}">{% trans 'here' %}</a>
				{% trans 'to see the questions you are following' %}.
			</p>
		</div>
		<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
	</div>
</div>
<div class="toast hide alert alert-info align-items-center mt-3 py-0 position-fixed top-0 start-50 translate-middle-x js-unfollowed-toast" role="alert" data-bs-animation="false" aria-live="assertive" aria-atomic="true">
	<div class="d-flex">
		<div class="toast-body">
			<p>	
				{% blocktrans %}
					You are no longer following this question. 
					You'll not receive notifications when there's activity on this post.
				{% endblocktrans %} <br>
				{% trans 'Click' %}
				<a href="{% url 'users:profile-qa' %}">{% trans 'here' %}</a>
				{% trans 'to see the questions you are following' %}.
			</p>
		</div>
		<button 
			type="button" 
			class="btn-close me-2 m-auto" 
			data-bs-dismiss="toast" 
			aria-label="{% trans 'Close' %}"
		>
		</button>
	</div>
</div>

{% get_login_url as login_url %}

<div class="border py-3 mb-5 container-lg">
	<article class="js-question" data-id="{{ question.id }}">
		{% with question_poster=question.poster %}
		<div class="text-end mb-3 mb-md-0 me-4">
			<a href="{% url 'qa_site:discuss-question-create' %}" class="btn btn-warning">
				{% trans 'Ask a Question' %}
			</a>
		</div>
		{# question info #}
		<p class="mb-lg-1">
			<span class="mx-1">
				{% trans 'Asked' %}
				<strong title="{{ question.posted_datetime }}">
					{{ question.posted_datetime|naturaltime }}
				</strong> 
			</span>
			<span class="mx-1">
				{% trans 'By' %}
				{% if question_poster.has_social_profile %}
					<a 
						class="px-1 bg-info opacity-75 text-decoration-none border-bottom-dotted" 
						href="{{ question_poster.get_absolute_url }}"
					>
						{{ question_poster.username }}
					</a>
				{% else %}
					<span 
						class="px-1 bg-info" 
						title="{% blocktrans %} User doesn't have a social profile {% endblocktrans %}"
					>
						{{ question_poster.username }}
					</span>
				{% endif %}
			</span>
			{% if question.school_id %}
				<span class="mx-1">
					{% trans 'Concerning' %}
					<a 
						href="{% url 'qa_site:discuss-question-list' %}?school={{ question.school_id }}" 
						class="text-decoration-none"
					>
						{{ question.school }}
					</a>
				</span>
			{% endif %}
			{% with view_count=question.view_count %}
			<p class="mx-1">
				{% trans 'Views' %}:
				<span class="ms-2">
					{{ view_count }}
					<i class="far fa-eye ms-1" aria-hidden="true"></i>
				</span>
			</p>
			{% endwith %}
		</p>

		<hr class="mb-3">
		<section class="mb-4 px-3 question-layout">
			{% with original_lang=question.original_language %}
			<div 
				class="mt-3 mb-4 question-content" 
				{% if question|should_attribute:LANGUAGE_CODE %} 
				lang="{{ original_lang|opposite_language }}-x-mtfrom-{{ original_lang }}" 
				{% endif %}
			>
				{{ question.content|safe }}
				{% include 'core/google_attribution.html' with object=question %}
			</div>
			{% endwith %}
			{% if question_tags.exists %}
				<div class="question-taglist">
					{% for tag in question_tags %}
						<span class="badge rounded-pill bg-secondary p-2">
							{{ tag.name }}
						</span>
					{% endfor %}
				</div>
			{% endif %}
			
			<!-- Question reactions -->
			<div class="mt-3 mb-3">
				<!-- upvote -->
				<div class="d-inline mx-2">
					<a 
						role="button" 
						class="text-decoration-none js-upvote" 
						data-id="{{ question.id }}"
						data-poster-id="{{ question.poster_id }}"
						data-thread="question"
						title="{% trans 'Vote this question UP if it is useful and clear. (click again to undo)' %}"
					>
						{% if user in question.upvoters.all %}
							<i class="fas fa-thumbs-up js-selected" aria-hidden="true"></i>
							{% trans 'Liked' %}
						{% else %}
							<i class="far fa-thumbs-up" aria-hidden="true"></i>
							{% trans 'Like' %}
						{% endif %}
					</a>
					<span class="ms-1 text-success">{{ question.upvote_count }}</span>
				</div>
				<!-- downvote -->
				<div class="d-inline mx-2">
					<a 
						role="button" 
						class="text-decoration-none js-downvote" 
						data-thread="question" 
						data-id="{{ question.id }}"
						data-poster-id="{{ question.poster_id }}"
						title="{% trans 'Vote this question DOWN if it is unclear or not useful. (click again to undo)' %}"
					>
						{% if user in question.downvoters.all %}
							<i class="fas fa-thumbs-down js-selected" aria-hidden="true"></i>
							{% trans 'Disliked' %}
						{% else %}
							<i class="far fa-thumbs-down" aria-hidden="true"></i>
							{% trans 'Dislike' %}
						{% endif %}
					</a>
					<span class="ms-1 text-danger">{{ question.downvote_count }}</span>
				</div>

				<!-- Bookmark area -->
				<div class="d-inline mx-2">
					{% url 'qa_site:discuss-bookmark-toggle' as bookmark_url %}
					{% url 'users:profile-qa' as bookmarks_url %}
					{% trans 'Add this question to your favourites. (click again to undo)' as title_text %}
					{% render_bookmark_template question bookmark_url bookmarks_url title_text %}
				</div>
				<!-- Share area -->
				<div class="d-inline mx-2">
					{% trans 'Share a link to this question' as heading %}
					{% include 'core/social_share_tooltip.html' with heading=heading title='' url=request.build_absolute_uri %}
				</div>
				<!-- flag area -->
				{# if question belongs to user, don't display follow widget. #}
				{% if user != question_poster %}
					<div class="d-inline ms-2">
						{% if user.is_anonymous %}
							<a href="{{ login_url }}?next={{ request.get_full_path }}" class="link-danger text-decoration-none">
								{% trans 'Report post' %}
								<span>
									{% include "flag/flag_icon.html" %}
								</span>
							</a>
						{% else %}
							<span class="link-danger js-flagHelper" role="button">
								{% if user|has_flagged:question %} 
									{% trans 'Remove flag' %}
								{% else %} 
									{% trans 'Report post' %} 
								{% endif %}
							</span> 
							{% render_flag_form question user request %}
						{% endif %}
					</div>
				{% endif %}
			</div>
			
			<!-- edit and delete area -->
			{% comment %} do this check only if user is authenticated; 
			since we need to determine if user can edit or delete the question {% endcomment %}
			{% if can_edit_question or can_delete_question %}
				<div class="mb-4">
					{% if can_edit_question %}
						<div class="d-inline mx-2">
							<a class="text-decoration-none link-danger" href="{% url 'qa_site:discuss-question-update' pk=question.pk %}">
								<i class="fas fa-edit me-1" aria-hidden="true"></i>
								{% trans 'Edit question' %}
							</a>
						</div>
					{% endif %}
					{% if can_delete_question %}
						<div class="d-inline mx-2">
							<a class="text-decoration-none link-danger" href="{% url 'qa_site:discuss-question-delete' pk=question.pk %}">
								<i class="fas fa-trash-alt me-1" aria-hidden="true"></i>
								{% trans 'Delete question' %}
							</a>
						</div>
					{% endif %}
				</div>
			{% endif %}

			<!-- follow area -->
			{# if question belongs to user, don't display follow widget. #}
			{% if user != question_poster %}
				{% trans 'to unfollow this question (stop getting notifications when anyone posts a new answer to this question).' as unfollow_text %}
				{% trans 'to follow this question (get notifications when anyone posts a new answer to this question).' as follow_text %}
				<p>
					<a data-id="{{ question.id }}" role="button" class="btn btn-sm {% if is_following %} btn-secondary js-selected {% else %} btn-outline-secondary {% endif %} js-follow-button">
						{% trans 'Click here' %} 
						<i class="fas fa-bullseye" aria-hidden="true"></i>
					</a> 
					<span class="js-follow-unfollow-text">
						{% if is_following %}
							{{ unfollow_text }}
						{% else %}
							{{ follow_text }}
						{% endif %}
					</span>
				</p>
			{% endif %}
		</section>

		{# container for jquery-comments #}
		<section id="question-comments"></section>

		{% endwith %}
	</article>

	<!-- Related Questions -->
	{% if related_qstns.exists %}
		<hr class="mb-4">
		<aside class="p-3">
			<h5 class="mb-3">{% trans 'Related Questions' %}</h5>
			{% for question in related_qstns %}
				{% with original_lang=question.original_language question_score=question.score %}
				<div class="mb-2"> <!-- class 'related-question' -->
					<a href="{{ question.get_absolute_url }}" class=" text-decoration-none">
						<span 
							class="
								badge align-middle px-2 py-1 me-2 
								{% if question_score > 0 %} bg-success 
								{% elif question_score < 0 %} bg-danger 
								{% else %} bg-secondary {% endif %}
							"
						>
							{{ question_score }}
						</span>
						<span>
							<span {% if question|should_attribute:LANGUAGE_CODE %} lang="{{ original_lang|opposite_language }}-x-mtfrom-{{ original_lang }}" {% endif %}>
								{{ question.content|remove_tags|truncatewords:50|safe }}
							</span> - 
							<strong>
								{{ question.num_answers }} 
								{% trans 'answer' %}{{ question.num_answers|pluralize }}
							</strong>
						</span>
					</a>
					<span class="small text-muted mx-2">{{ question.posted_datetime|naturaltime }}</span>
					{% include 'core/google_attribution.html' with object=question %}
					<a class="link-success" href="{{ question.get_absolute_url }}">{% trans 'Answer this' %}</a>
				</div>
				{% endwith %}
			{% endfor %}
		</aside>
	{% else %}
		<br>
	{% endif %}
</div>
{% endblock content %}


{% block extra_js %}
<script>
	/* Get current user's id.. */
	// if user isn't logged in, user.id and userPoints will be "None"
	var userId = "{{ user.id }}", userPoints = "{{ user.site_points }}";
	var requiredDownvotePoints = {{ required_downvote_points }};
	userId = (userId == "None" ? null : userId);
	var csrfToken = "{{ csrf_token }}";
	// reduce margin of paragraphs so as to use less space..
	$('.js-comment-wrp').children('p').css('margin-bottom', '.2rem');

	/* FLAG FORM */
	// trigger click on flag-report-icon when flag helper is clicked
	$('.js-flagHelper').click(function() {
		var $parentWrp = $(this).parent();
		// console.log($parentWrp);
		$parentWrp.find('.js-flag-report-icon').first().click();
		// $('.js-flag-report-icon').first().click();
	});

	// possible thread types are {question, comment}
	var THREAD_TYPES = ["question", "comment"];
	var $upvoteTriggerer = $('.js-upvote'), $downvoteTriggerer = $('.js-downvote');

	/* Get current user's id.. */
	// if user isn't logged in, user.id and userPoints will be "None"
	var userId = "{{ user.id }}", userPoints = "{{ user.site_points }}";
	var requiredDownvotePoints = {{ required_downvote_points }};
	userId = (userId == "None" ? null : userId);
	var csrfToken = "{{ csrf_token }}";

	function onVote(event) {
		// if user isn't logged in
		if (!userId) {
			// prevent other handlers from being called(prevent sending request to backend)
			event.stopImmediatePropagation();
			displayToast('LOGIN_REQUIRED');
			return false;
		}

		// if thread type is invalid
		var threadType = event.currentTarget.dataset.thread;
		if (!THREAD_TYPES.includes(threadType)) {
			event.stopImmediatePropagation();
			displayToast('ERROR_OCCURRED');
			return false;
		}

		// if user is voting for their post
		if (userId === this.dataset.posterId) {
			event.stopImmediatePropagation();
			displayToast('SELF_VOTE');
			return false;
		}
	}

	$upvoteTriggerer.click(onVote);
	$downvoteTriggerer.click(onVote);

	/* UPVOTES */
	$upvoteTriggerer.click(function() {
		var $this = $(this);
		var $icon = $this.children('i'), id = parseInt(this.dataset.id, 10);
		
		// possible thread types are {question, comment}
		var voteType = 'up', threadType = this.dataset.thread;
		var url = "{% url 'qa_site:discuss-thread-vote' %}";

		// if user is trying to undo the vote(the upvote)
		if ($icon.hasClass('js-selected')) {
			var voteAction = 'recall-vote';

			$.ajax({
				url: url,
				type: 'POST',
				dataType: 'json',
				data: {id: id, vote_type: voteType, thread_type: threadType, action: voteAction},
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				success: function(response) {
					if (response['success']) {
						// remove fas(font-awesome solid) class and set to far(font-awesome regular)
						$icon.removeClass('fas js-selected').addClass('far');

						// update number of votes
						if (threadType == 'comment') {
							// update vote count
							// span comes before vote icon for comments
							var $voteCounter = $this.parent().prev();
							var prevCount = parseInt($voteCounter.text(), 10);

							// if no vote was on comment(if the voteCounter is empty)
							if (Number.isNaN(prevCount)) {
								$voteCounter.text('1');
							} else {
								$voteCounter.text(prevCount - 1);
							}
							
						} else {
							var $voteCounter = $this.next();
							var prevCount = parseInt($voteCounter.text(), 10);
							$voteCounter.text(prevCount - 1);
							
							// update text
							var textNode = $icon[0].nextSibling;
							textNode.textContent = " {% trans 'Like' %}";
						}
					} else {
						// console.log(response);
						displayToast('CUSTOM_ERROR', response['message']);
					}
				}
			});

		} else {
			// if user is adding a new vote
			var voteAction = 'vote';

			$.ajax({
				url: url,
				type: 'POST',
				data: {id: id, vote_type: voteType, thread_type: threadType, action: voteAction},
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				success: function(response) {
					if (response['success']) {
						// remove far class and set to fas
						$icon.removeClass('far').addClass('fas js-selected');

						if (threadType == 'comment') {
							// update vote count
							// span comes before vote icon for comments
							var $voteCounter = $this.parent().prev();
							var prevCount = parseInt($voteCounter.text(), 10);

							// if no vote was on comment(if the voteCounter is empty)
							// set vote count to 1
							if (Number.isNaN(prevCount)) {
								$voteCounter.text('1');
							} else {
								$voteCounter.text(prevCount + 1);
							}
						} else {
							// update count
							var $voteCounter = $this.next();
							var prevCount = parseInt($voteCounter.text(), 10);
							$voteCounter.text(prevCount + 1);

							// update text
							var textNode = $icon[0].nextSibling;
							textNode.textContent = " {% trans 'Liked' %}";
						}
					} else {
						// console.log(response);
						displayToast('CUSTOM_ERROR', response['message']);
					}
				},
				error: function() {
					console.error("Error");
				}
			});
		}
	});

	/* DOWNVOTES */
	$downvoteTriggerer.click(function() {
		var $this = $(this);
		var $icon = $this.children('i'), id = parseInt(this.dataset.id, 10);
		var voteType = 'down', threadType = this.dataset.thread;
		var url = "{% url 'qa_site:discuss-thread-vote' %}";

		// if user is trying to undo the vote(the upvote)
		if ($icon.hasClass('js-selected')) {
			var voteAction = 'recall-vote';

			$.ajax({
				url: url,
				type: 'POST',
				data: {id: id, vote_type: voteType, thread_type: threadType, action: voteAction},
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				success: function(response) {
					if (response['success']) {
						// remove fas(font-awesome solid) class and set to far(font-awesome regular)
						$icon.removeClass('fas js-selected').addClass('far');

						// update count
						var $voteCounter = $this.next();
						var prevCount = parseInt($voteCounter.text(), 10);
						$voteCounter.text(prevCount - 1);

						// update text
						var textNode = $icon[0].nextSibling;
						textNode.textContent = " {% trans 'Dislike' %}";
					} else {
						// console.log(response);
						displayToast('CUSTOM_ERROR', response['message']);
					}
				}
			});

		} else {
			// if user is adding a new vote
			var voteAction = 'vote';

			// user should have number of points required
			// isNumeric function is in the base.min.js file
			if (isNumeric(userPoints) && userPoints < requiredDownvotePoints) {
				var toastMsg = {% blocktrans %} "You need at least <strong>{{ required_downvote_points }} points</strong> to be able to add a dislike." {% endblocktrans %};
				displayToast('CUSTOM_ERROR', toastMsg);
				return false;
			}

			$.ajax({
				url: url,
				type: 'POST',
				data: {id: id, vote_type: voteType, thread_type: threadType, action: voteAction},
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				success: function(response) {
					if (response['success']) {
						// remove far class and set to fas
						$icon.removeClass('far').addClass('fas js-selected');

						// update count
						var $voteCounter = $this.next();
						var prevCount = parseInt($voteCounter.text(), 10);
						$voteCounter.text(prevCount + 1);

						// update text
						var textNode = $icon[0].nextSibling;
						textNode.textContent = " {% trans 'Disliked' %}";
					} else {
						// console.log(response);
						displayToast('CUSTOM_ERROR', response['message']);
					}
				}
			});
		}

	});

	/** FOLLOWING **/
	// do this only if user isn't owner of question
	{% if user.id != question.poster_id %}
		// no need to complicate following by creating another template and script
		// besides it is used in only two templates; (both questions detail templates)
		$('.js-follow-button').click(function(event) {
			// if user isn't logged in
			if (!userId) {
				displayToast('LOGIN_REQUIRED');
				return false;
			}

			var $this = $(this);
			var id = parseInt(this.dataset.id, 10);
			var url = "{% url 'qa_site:discuss-follow-toggle' %}";
			var $followUnfollowSpan = $('.js-follow-unfollow-text').first();
			
			// if user is trying to undo the follow
			if ($this.hasClass('js-selected')) {
				var voteAction = 'recall-follow';

				$.ajax({
					url: url,
					type: 'POST',
					data: {id: id, action: voteAction},
					dataType: 'json',
					beforeSend: function (xhr) {
						xhr.setRequestHeader("X-CSRFToken", csrfToken);
					},
					success: function(result) {
						if (result['unfollowed']) {
							$this.removeClass('js-selected btn-secondary').addClass('btn-outline-secondary');
							$followUnfollowSpan.text({{ follow_text }});
							displayToast('FOLLOW_TOGGLE', false);

						} else {
							console.error(result);
							displayToast('ERROR_OCCURRED');
						}
					}
				});

			} else {
				// if user is following question
				var voteAction = 'follow';

				$.ajax({
					url: url,
					type: 'POST',
					data: {id: id, action: voteAction},
					dataType: 'json',
					beforeSend: function (xhr) {
						xhr.setRequestHeader("X-CSRFToken", csrfToken);
					},
					success: function(result) {
						if (result['followed']) {
							$this.removeClass('btn-outline-secondary').addClass('js-selected btn-secondary');
							$followUnfollowSpan.text({{ unfollow_text }});
							displayToast('FOLLOW_TOGGLE', true);
						} else {
							console.error(result);
							displayToast('ERROR_OCCURRED');
						}
					}
				});
			}
		});
	{% endif %}
</script>
<script>
	var usersMentioned = [];
	$.ajax({
		type: 'GET',
		url: "{% url 'qa_site:users-mentioned' question.id %}?model_name=DiscussQuestion",
		success: function(result, status, jqXHR) {
			console.log(result);
			usersMentioned = result.data;
		},
		error: function(jqXHR, status, error) {
			console.error(error);
		}
	});

	{# jquery-comments config, https://viima.github.io/jquery-comments #}
	$('#question-comments').comments({
		textareaPlaceholderText: "{% trans 'Add a comment' %}",
		newestText: "{% trans 'Newest' %}",
		oldestText: "{% trans 'Oldest' %}",
		popularText: "{% trans 'Popular' %}",
		attachmentsText: "{% trans 'Attachments' %}",
		sendText: "{% trans 'Comment' %}",
		replyText: "{% trans 'Reply' %}",
		editText: "{% trans 'Edit' %}",
		editedText: "{% trans 'Edited' %}",
		youText: "{% trans 'You' %}",
		saveText: "{% trans 'Save' %}",
		deleteText: "{% trans 'Delete' %}",
		viewAllRepliesText: "{% trans 'View all' %} " + "__replyCount__" + " {% trans 'replies' %} ",
		hideRepliesText: "{% trans 'Hide replies' %}",
		noCommentsText: "{% trans 'No comments' %}",
		noAttachmentsText: "{% trans 'No attachments' %}",
		attachmentDropText: "{% trans 'Drop files here' %}",
		roundProfilePictures: true,
		profilePictureUrl: (function() {
			{% with profile_image=user.social_profile.profile_image %}
			var url = "{% if profile_image %}{{ profile_image.url }}{% endif %}";
			{% endwith %}
			return url;
		})(),
		currentUserIsAdmin: {% if user.is_staff %} true {% else %} false {% endif %},
		enablePinging: true,
		_parseComment: function(data) {
			// Convert pings to human readable format
			$(Object.keys(data.pings)).each(function(index, userId) {
				var username = data.pings[userId];
				var pingText = '@' + username;
				data.content = data.content.replace(new RegExp('@' + userId, 'g'), pingText);
			});
	
			return data;
		},
		searchUsers: function(term, success, error) {;
			// setTimeout(function() {
			success(usersMentioned.filter(function(user) {
				var containsSearchTerm = user.username.toLowerCase().indexOf(term.toLowerCase()) != -1;
				var isNotSelf = user.id != userId;
				return containsSearchTerm && isNotSelf;
			}));
		 	// }, 500);
		},
		getComments: function(success, error) {
			$.ajax({
				type: 'GET',
				url: "{% url 'qa_site:discuss-comments-cl' %}",
				success: function(result) {
					console.log(result);
					success(result.data);
				},
				error: error
			});
		},
		postComment: function(commentJSON, success, error) {
			var that = this;
			$.ajax({
				type: 'POST',
				url: "{% url 'qa_site:discuss-comments-cl' %}",
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				data: {
					parent_id: commentJSON.parent,
					question_id: {{ question.id }},
					content: commentJSON.content
				},
				success: function(result) {
					console.log(that);
					success(that._parseComment(result.data));
				},
				error: error
			});
		},
		putComment: function(commentJSON, success, error) {
			var that = this;
			$.ajax({
				type: 'PUT',
				// use cl instead of cud then append id...
				// since javascript vars do not work in python
				url: "{% url 'qa_site:discuss-comments-cl' %}" + commentJSON.id + '/',
				data: JSON.stringify({
					content: commentJSON.content
				}),
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				success: function(result) {
					success(that._parseComment(result.data));
				},
				error: error
			});
		},
		deleteComment: function(commentJSON, success, error) {
			$.ajax({
				type: 'DELETE',
				url: "{% url 'qa_site:discuss-comments-cl' %}" + commentJSON.id + '/',
				beforeSend: function (xhr) {
					xhr.setRequestHeader("X-CSRFToken", csrfToken);
				},
				success: success,
				error: error
			});
		},
		upvoteComment: function(commentJSON, success, error) {
			var upvotesURL = "{% url 'qa_site:discuss-thread-vote' %}";
	  
			// Recalling upvote
			if(commentJSON.userHasUpvoted) {
				$.ajax({
					type: 'POST',
					url: upvotesURL,
					data: {
						id: commentJSON.id, 
						vote_type: 'up', 
						thread_type: 'comment', 
						action: 'recall-vote'
					},
					beforeSend: function (xhr) {
						xhr.setRequestHeader("X-CSRFToken", csrfToken);
					},
					success: function() {
						success(commentJSON);
					},
					error: error
				});
			} else {
				$.ajax({
					type: 'POST',
					url: upvotesURL,
					data: {
						id: commentJSON.id, 
						vote_type: 'up', 
						thread_type: 'comment', 
						action: 'vote'
					},
					beforeSend: function (xhr) {
						xhr.setRequestHeader("X-CSRFToken", csrfToken);
					},
					success: function() {
						success(commentJSON);
					},
					error: error
				});
			}
		},
		pingClicked: function(ping) {
			alert(ping);
		},
		timeFormatter: function(time) {
			return new Date(time).toLocaleDateString();
		},

	});
</script>

{% endblock %}